
image: docker:latest

variables:
  APP_REPOSITORY_URL_STAGE: 447866867700.dkr.ecr.us-west-2.amazonaws.com/stage/irving/app
  APP_REPOSITORY_URL_PROD: 447866867700.dkr.ecr.us-west-2.amazonaws.com/prod/irving/app

services:
  - postgres:latest

stages:
  - build
  - test
  - deploy
  - kube

cache:
  paths:
    - build
    - deployments/cdk/dist

deploy-staging:
  stage: deploy
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl jq python3 py-pip
    - pip install awscli
  script:
    - $(aws ecr get-login --no-include-email --region us-west-2)
    - docker pull $APP_REPOSITORY_URL_STAGE:latest || true
    - docker build -f ./deployments/Dockerfile --cache-from $APP_REPOSITORY_URL_STAGE:latest -t $APP_REPOSITORY_URL_STAGE:$CI_COMMIT_SHA -t $APP_REPOSITORY_URL_STAGE:latest .
    - docker push $APP_REPOSITORY_URL_STAGE:$CI_COMMIT_SHA
    - docker push $APP_REPOSITORY_URL_STAGE:latest
  environment:
    name: staging
  only:
  - develop

deploy-production:
  stage: deploy
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl jq python3 py-pip
    - pip install awscli
  script:
    - $(aws ecr get-login --no-include-email --region us-west-2)
    - docker pull $APP_REPOSITORY_URL_PROD:latest || true
    - docker build -f ./deployments/Dockerfile --cache-from $APP_REPOSITORY_URL_PROD:latest -t $APP_REPOSITORY_URL_PROD:$CI_COMMIT_SHA -t $APP_REPOSITORY_URL_PROD:latest .
    - docker push $APP_REPOSITORY_URL_PROD:$CI_COMMIT_SHA
    - docker push $APP_REPOSITORY_URL_PROD:latest
  environment:
    name: production
  only:
  - master
